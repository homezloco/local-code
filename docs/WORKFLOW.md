
# Agent Workflow Diagram

## Current Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USER INTERFACE                                      â”‚
â”‚                          (Dashboard - Port 3002)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           MASTER AGENT API                                        â”‚
â”‚                          (Express - Port 3001)                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Tasks     â”‚  â”‚   Agents     â”‚  â”‚  Workflows  â”‚  â”‚  DelegationEngine â”‚  â”‚
â”‚  â”‚  Routes    â”‚  â”‚   Routes     â”‚  â”‚   Routes    â”‚  â”‚  - classifyTask()  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  - delegateTask()  â”‚  â”‚
â”‚                                                      â”‚  - executeDelegate()â”‚  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  - multi-agent     â”‚  â”‚
â”‚  â”‚              TaskDelegation Model               â”‚ â”‚    collaboration   â”‚  â”‚
â”‚  â”‚  (SQLite Database)                              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                           â”‚
                    â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    AGENT SERVICE            â”‚   â”‚            SHARED RAG SERVICE               â”‚
â”‚    (Port 7788)             â”‚   â”‚            (Port 7777)                      â”‚
â”‚                             â”‚   â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  /execute endpoint     â”‚ â”‚   â”‚  â”‚  Semantic Search                    â”‚ â”‚
â”‚  â”‚  - ReAct Loop          â”‚ â”‚   â”‚  â”‚  - Embeddings (nomic-embed-text)    â”‚ â”‚
â”‚  â”‚  - Max 6 iterations   â”‚ â”‚   â”‚  â”‚  - Chunked context (k=8)           â”‚ â”‚
â”‚  â”‚  - SSE streaming      â”‚ â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚                                             â”‚
â”‚            â”‚                â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚            â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚    OLLAMA             â”‚ â”‚
â”‚  â”‚  (Port 11434)        â”‚ â”‚
â”‚  â”‚                       â”‚ â”‚
â”‚  â”‚  - gemma3:1b         â”‚ â”‚
â”‚  â”‚  - qwen2.5-coder     â”‚ â”‚
â”‚  â”‚  - codellama         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Task Delegation Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚â”€â”€â”€â”€â–¶â”‚  Dashboard    â”‚â”€â”€â”€â”€â–¶â”‚  Master Agent   â”‚â”€â”€â”€â”€â–¶â”‚ Agent Service  â”‚
â”‚ Creates  â”‚     â”‚  (React UI)   â”‚     â”‚  /delegate     â”‚     â”‚  /execute     â”‚
â”‚  Task    â”‚     â”‚               â”‚     â”‚                â”‚     â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚                        â”‚
                                         â–¼                        â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ classifyTask()  â”‚     â”‚   ReAct Loop   â”‚
                                â”‚                 â”‚     â”‚                â”‚
                                â”‚ Phase 1:        â”‚     â”‚ 1. Thought     â”‚
                                â”‚   Keywords      â”‚     â”‚ 2. Action      â”‚
                                â”‚ Phase 2:        â”‚     â”‚ 3. Observation â”‚
                                â”‚   LLM Fallback  â”‚     â”‚ 4. Repeat      â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                â”‚ Select Agent     â”‚
                                â”‚                 â”‚
                                â”‚ - coding-agent  â”‚
                                â”‚ - email-agent   â”‚
                                â”‚ - etc.          â”‚
                                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Mermaid Diagram (Copy to mermaid.live)

```mermaid
flowchart TB
    subgraph USER["ðŸ‘¤ User + Dashboard (Port 3002)"]
        UI["React Dashboard"]
    end

    subgraph MASTER["ðŸ–¥ï¸ Master Agent API (Port 3001)"]
        API["Express Server"]
        TE["DelegationEngine"]
        DB["SQLite Database"]
        
        subgraph ROUTES["Routes"]
            TR["Tasks"]
            AR["Agents"]
            WR["Workflows"]
            DR["Delegate"]
        end
    end

    subgraph AGENT["ðŸ¤– Agent Service (Port 7788)"]
        EX["/execute Endpoint"]
        RL["ReAct Loop"]
    end

    subgraph AI["ðŸ§  Ollama (Port 11434)"]
        OLLAMA["gemma3:1b, qwen2.5-coder, codellama"]
    end

    subgraph RAG["ðŸ“š RAG Service (Port 7777)"]
        SEARCH["Semantic Search"]
        EMBED["Embeddings"]
    end

    subgraph MEMORY["ðŸ’¾ Memory Service"]
        MEM["Long-term Memory"]
    end

    UI -->|"POST /tasks"| TR
    UI -->|"POST /delegate/:id"| DR
    TR --> TE
    DR --> TE
    TE -->|"classifyTask()"| TE
    TE -->|"LLM Classification"| OLLAMA
    TE --> EX
    EX --> RL
    RL -->|"Generate"| OLLAMA
    RL -->|"RAG Context"| SEARCH
    SEARCH --> EMBED
    TE -->|"Memory Search"| MEM
    TE -->|"Read/Write"| DB
    UI -->|"SSE Stream"| DR
```

## Status Transitions

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚pending  â”‚â”€â”€â”€â”€â–¶â”‚delegated â”‚â”€â”€â”€â”€â–¶â”‚ in_progress â”‚â”€â”€â”€â”€â–¶â”‚completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚                   â”‚
     â”‚              â”‚                   â–¼
     â”‚              â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚              â”‚ review â”‚ (human-in-loop)
     â”‚              â”‚              â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚              â”‚                  â”‚
     â”‚              â”‚            â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
     â”‚              â”‚            â–¼           â–¼
     â”‚              â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚      â”‚  resume  â”‚ â”‚  failed  â”‚
     â”‚              â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚              â”‚           â”‚
     â–¼              â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚cancelledâ”‚    â”‚  failed   â”‚ â”‚completed â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Auto-Retry Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  First   â”‚â”€â”€â”€â”€â–¶â”‚ Failed   â”‚â”€â”€â”€â”€â–¶â”‚  Wait    â”‚â”€â”€â”€â”€â–¶â”‚  Retry   â”‚
â”‚ Attempt  â”‚     â”‚          â”‚     â”‚  5s      â”‚     â”‚  #1      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                            â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â–¼
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚  Failed   â”‚â”€â”€â”€â”€â–¶â”‚  Wait    â”‚â”€â”€â”€â”€â–¶â”‚  Retry   â”‚
                        â”‚           â”‚     â”‚  10s     â”‚     â”‚  #2      â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                                                â”‚
                                    MAX 2 RETRIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                â–¼
                                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                        â”‚  Failed  â”‚
                                                        â”‚ Final    â”‚
                                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Clarification Flow (Human-in-the-Loop)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agent   â”‚â”€â”€â”€â”€â–¶â”‚   Needs      â”‚â”€â”€â”€â”€â–¶â”‚    Dashboard    â”‚â”€â”€â”€â”€â–¶â”‚    User       â”‚
â”‚ Result   â”‚     â”‚ Clarificationâ”‚     â”‚    Shows       â”‚     â”‚   Provides    â”‚
â”‚          â”‚     â”‚              â”‚     â”‚    Modal       â”‚     â”‚   Answers     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                       â”‚
                                                                       â–¼
                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚ POST /clarify         â”‚
                                                          â”‚ (answers in body)     â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                      â”‚
                                                                      â–¼
                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                          â”‚ Resume Delegation     â”‚
                                                          â”‚ with context          â”‚
                                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Recommended Improvements

### 1. Add Callback Webhooks for Task Completion
- **Current**: Polling / SSE
- **Proposed**: Webhook notifications

### 2. Add Agent-to-Agent Communication
- **Current**: Sequential handoff passes results manually
- **Proposed**: Direct agent messaging

### 3. Add Task Dependencies
- **Current**: All tasks independent
- **Proposed**: Dependency graph (Task B waits for Task A)

### 4. Add Built-in Agent Feedback Loop
- **Current**: Manual re-delegation
- **Proposed**: Self-improvement with result analysis

### 5. Add Priority Queue for Delegation
- **Current**: FIFO (First In, First Out)
- **Proposed**: Priority-based (urgent > high > medium > low)

### 6. Add Timeout Configuration Per Agent
- **Current**: Global timeout
- **Proposed**: Agent-specific timeouts

### 7. Add Task Templates Library
- **Current**: Manual task creation
- **Proposed**: Pre-built templates

## Implementation Priority

| Priority | Improvement | Effort | Impact |
|----------|-------------|--------|--------|
| High     | Task Dependencies | Medium | High |
| High     | Priority Queue | Medium | High |
| Medium   | Agent-specific Timeouts | Low | Medium |
| Medium   | Webhook Notifications | Medium | Medium |
| Medium   | Task Templates | Low | Medium |
| Low      | Agent-to-Agent Direct | High | High |
| Low      | Self-Healing Feedback | High | High |
